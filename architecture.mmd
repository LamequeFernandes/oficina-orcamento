graph TB
    subgraph CLIENT["Cliente / Mecânico"]
        C1[Aplicação Web / Mobile]
        C2[Postman / API Consumer]
    end

    subgraph AUTH["Auth Service (Lambda)"]
        Lambda[AWS Lambda\nGeração de JWT]
    end

    subgraph K8S["Kubernetes EKS — namespace: oficina"]
        LB[LoadBalancer\nPort 8000]

        subgraph POD["oficina-orcamento"]
            direction TB
            subgraph PRES["Presentation Layer"]
                R1[/orcamento]
                R2[/orcamento/id/status]
                R3[/orcamento/id/status-pagamento]
                R4[/webhook/mercadopago]
                R5[/servicos]
                R6[/pecas]
            end

            subgraph APP["Application Layer"]
                UC1[CriarOrcamentoUseCase]
                UC2[AlterarStatusOrcamentoUseCase]
                UC3[ProcessarWebhookMercadoPagoUseCase]
                UC4[ConsultarStatusPagamentoUseCase]
                UC5[CriarServicoUseCase]
                UC6[CriarPecaUseCase]
            end

            subgraph DOMAIN["Domain Layer"]
                E1[Orcamento\n status · mp_payment_id]
                E2[Servico + TipoServico]
                E3[Peca + TipoPeca]
            end

            subgraph INFRA["Infrastructure Layer"]
                REP1[OrcamentoRepository]
                REP2[ServicoRepository]
                REP3[PecaRepository]
                MAP[Mappers Entity ↔ Model]
            end

            subgraph CORE["Core"]
                SEC[security.py\nJWT Validation]
                UTILS[utils.py\nMP Checkout & OS Status]
                DB[database.py\nSQLAlchemy Session]
            end
        end

        HPA[HPA\nMin 1 / Max 5\nCPU 70%]
        SEC_K8S[Secret: api-secrets]
    end

    subgraph DB_LAYER["AWS RDS — MySQL"]
        DB_ORC[(oficina_orcamento\norcamento · servico · peca\ntipo_servico · tipo_peca)]
    end

    subgraph MP["Mercado Pago API"]
        MP_CHK[POST /checkout/preferences\nGerar link de pagamento]
        MP_PAY[GET /v1/payments/id\nVerificar pagamento]
        MP_WH[Webhook IPN → /webhook/mercadopago]
    end

    subgraph OS_SVC["Microsserviço Ordem de Serviço\n:8001"]
        OS_STATUS[PATCH /veiculos/1/ordens_servico/id/status]
    end

    subgraph CICD["CI/CD — GitHub Actions"]
        T[pytest + coverage ≥ 80%]
        BI[docker build]
        PUS[push DockerHub\nlamequesao/oficina-orcamento]
        DEP[kubectl apply\nrolling update]
    end

    %% Request flow
    C1 -->|Bearer JWT| LB
    C2 -->|Bearer JWT| LB
    C1 -->|POST /auth| Lambda
    Lambda -->|JWT| C1
    LB --> PRES

    %% Internal flow
    PRES --> APP
    APP --> DOMAIN
    APP --> INFRA
    INFRA --> CORE
    CORE --> DB_ORC

    %% MP Integration
    UTILS -->|gerar preferência| MP_CHK
    UTILS -->|verificar pagamento| MP_PAY
    MP_WH -->|notificação IPN/v2| R4

    %% OS Integration
    UTILS -->|atualizar status OS| OS_STATUS

    %% K8s
    HPA -.->|escala| POD
    SEC_K8S -.->|env vars| POD

    %% CI/CD
    T --> BI --> PUS --> DEP --> POD

    classDef layer fill:#1e3a5f,stroke:#4a90d9,color:#fff
    classDef ext fill:#2d6a4f,stroke:#52b788,color:#fff
    classDef mp fill:#005f3c,stroke:#00b37e,color:#fff
    classDef db fill:#6b2737,stroke:#c9184a,color:#fff
    classDef k8s fill:#1a4971,stroke:#5ba4cf,color:#fff
    classDef cicd fill:#3d405b,stroke:#81b29a,color:#fff

    class PRES,APP,DOMAIN,INFRA,CORE layer
    class OS_STATUS,Lambda ext
    class MP_CHK,MP_PAY,MP_WH mp
    class DB_ORC db
    class LB,HPA,SEC_K8S k8s
    class T,BI,PUS,DEP cicd
